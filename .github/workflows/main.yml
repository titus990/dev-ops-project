name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  docker:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout full git history (IMPORTANT for diff)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Detect changes between origin and current commit
      - name: Detect code changes
        id: changes
        run: |
          if git diff --quiet origin/main...HEAD; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ùå No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected"
          fi

      # 3Ô∏è‚É£ Stop pipeline early if no changes
      - name: Skip if no changes
        if: steps.changes.outputs.changed == 'false'
        run: |
          echo "üö´ Skipping pipeline because no changes were detected"
          exit 0

      # 4Ô∏è‚É£ Setup Docker
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 5Ô∏è‚É£ Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6Ô∏è‚É£ Build Test Image
      - name: Build Docker Image (Test)
        run: docker build -t boxing-app:test .

      # 7Ô∏è‚É£ Run Container Locally
      - name: Run container
        run: |
          docker run -d -p 3000:3000 --name test-container boxing-app:test
          sleep 5

      # 8Ô∏è‚É£ LIVE LINK HEALTH CHECK (only if code changed)
      - name: Health Check on Live Deployment
        run: |
          echo "‚è≥ Waiting for live app to respond..."

          for i in {1..15}; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://dev-ops-project-production.up.railway.app || true)

            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Live app is healthy (HTTP 200)"
              exit 0
            fi

            echo "Attempt $i: App not ready (status: $STATUS)"
            sleep 2
          done

          echo "‚ùå Live app failed health check"
          exit 1

      # 9Ô∏è‚É£ Cleanup
      - name: Cleanup
        run: |
          docker stop test-container
          docker rm test-container

      # üîü Build Production Image
      - name: Build Production Image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/boxing-app:latest .

      # 1Ô∏è‚É£1Ô∏è‚É£ Push Image
      - name: Push Docker Image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/boxing-app:latest

      # 1Ô∏è‚É£2Ô∏è‚É£ Deployment Info
      - name: Deployment Link
        run: |
          echo "üöÄ Image pushed to Docker Hub"
          echo "üîó https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/boxing-app"
